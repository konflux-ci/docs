[[generating-dynamic-labels-or-annotations]]
= Generating dynamic labels or annotations

You can generate dynamic labels and annotations for your container images by integrating a specialized Tekton task into your build pipeline. This task typically uses Git metadata, such as commit timestamps and branch names (or a dedicated version parameter), to create standardized OCI image labels.

The `generate-labels` task (for example, `quay.io/konflux-ci/tekton-catalog/task-generate-labels:0.1`) is designed for this purpose. It can take various inputs and produce a set of labels that are then applied to your image during the build process.

.Prerequisites
* Your build pipeline (`build-pipeline.yaml` or similar) is defined and version-controlled in your repository.
* Your pipeline includes a task for cloning the Git repository (e.g., `clone-repository` which uses `git-clone-oci-ta`) that provides results like commit timestamp and branch/revision information.

.Procedure

. **Add a Pipeline Parameter for Versioning (Recommended):**
  To have consistent versioning information for both labels and tags, add a dedicated version parameter to your `build-pipeline.yaml`. This parameter will be supplied by your `PipelineRun`.
+
[source,yaml]
----
# In .tekton/build-pipeline.yaml
spec:
  params:
    # ... other params ...
    - name: artifact-version
      description: Version to use for the container image labels and tags.
      type: string
      default: "main" # Or any suitable default
----

. **Integrate the `generate-labels` Task into Your Pipeline:**
  Add a new task to your `build-pipeline.yaml` that uses the `generate-labels` task. This task should run after the `clone-repository` task to use its results.
+
[source,yaml]
----
# In .tekton/build-pipeline.yaml
spec:
  tasks:
    # ... other tasks like init, clone-repository, prefetch-dependencies ...

    - name: generate-image-labels
      runAfter:
        - clone-repository
        # - prefetch-dependencies # If applicable
      taskRef:
        resolver: bundles
        params:
          - name: name
            value: generate-labels # The name of the task within the bundle
          - name: bundle
            # Replace with the specific bundle and digest for the generate-labels task you are using
            value: quay.io/konflux-ci/tekton-catalog/task-generate-labels:0.1@sha256:2eea900077190535c4dbb30e9bcc2da357bd53c408613485fb3af53484afdcbd
          - name: kind
            value: task
      params:
        - name: label-templates # Define the labels you want to generate
          value:
            # Uses the $SOURCE_DATE variable provided by the task, derived from source-date-epoch
            - "build-date=$SOURCE_DATE"
            # Uses the $SOURCE_DATE_EPOCH variable provided by the task
            - "release=$SOURCE_DATE_EPOCH"
            # Uses the pipeline parameter 'artifact-version'
            - "version=$(params.artifact-version)"
            # Example of another common OCI label using git-clone results
            - "org.opencontainers.image.revision=$(tasks.clone-repository.results.commit)"
            - "org.opencontainers.image.source=$(tasks.clone-repository.results.url)"
        - name: source-date-epoch # Provide the commit timestamp to the task
          value: "$(tasks.clone-repository.results.commit-timestamp)"
      # The generate-labels task typically produces a result like 'labels' (an array of strings)
      # or 'LABELS_OCI_ARTIFACT' (an OCI artifact path) depending on the version.
      # The example here assumes it produces a 'labels' array result.

    - name: build-images # Your existing buildah task (e.g., buildah-remote-oci-ta)
      runAfter:
        - generate-image-labels # Ensure labels are generated first
      params:
        # ... other buildah params ...
        - name: LABELS # Parameter name for buildah to accept labels
          value:
            - $(tasks.generate-image-labels.results.labels[*]) # Pass the generated labels
      # ... rest of the build-images task ...
----
+
*Key parameters for the `generate-labels` task:*
** `label-templates`: An array of strings where each string is a label template.
*** You can use variables like `$SOURCE_DATE` and `$SOURCE_DATE_EPOCH` which the task derives from the `source-date-epoch` input.
*** You can also use Tekton parameter substitution `$(params.parameter-name)` and task result substitution `$(tasks.task-name.results.result-name)`.
** `source-date-epoch`: This should be populated with the commit timestamp, typically from the `clone-repository` task's result (`$(tasks.clone-repository.results.commit-timestamp)`). This is used by the task to set `SOURCE_DATE_EPOCH` internally and derive `$SOURCE_DATE`.

. **Pass `artifact-version` from `PipelineRun`:**
  In your `PipelineRun` files (e.g., `component-push.yaml`), pass the `artifact-version` parameter.
+
[source,yaml]
----
# In .tekton/component-push.yaml (for push to main)
spec:
  params:
    # ... other params ...
    - name: artifact-version
      value: '{{target_branch}}' # Using PaC variable for branch name

# In .tekton/component-on-pull-request.yaml (for PRs)
spec:
  params:
    # ... other params ...
    - name: artifact-version
      value: '{{target_branch}}-pr-{{pull_request_number}}' # Example for PRs
----

.Verification
* After a successful pipeline run, inspect your image on Quay.io or using a tool like `skopeo`.
* You should see labels like `build-date`, `release`, and `version` applied to your image, with values derived from the commit timestamp and the `artifact-version` parameter.

This approach ensures that your images are consistently labeled with important build and versioning information, enhancing traceability and adherence to OCI standards.
